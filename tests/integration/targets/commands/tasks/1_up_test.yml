- name: up tests
  tags: up
  block:
  - name: Start the 2 vagrant instances to log into
    jclaveau.vagrant.up:
    args:
      name: "{{ item }}"
    loop:
      - "srv001"
      - "srv002"
    async: 90  # async is used to make tests faster and illustrate an optimized
    poll: 0
    register: async_loop

  # - name: dbg async_loop
  #   ansible.builtin.debug:
  #     var: async_loop

  - name: wait for up to finish
    async_status:
      jid: "{{item.ansible_job_id}}"
      mode: status
    retries: 120
    delay: 1
    loop: "{{async_loop.results}}"
    register: async_loop_jobs
    until: async_loop_jobs.finished

  - name: dbg up results
    ansible.builtin.debug:
      var: async_loop_jobs

  - name: Vagrant up should succeed
    assert:
      that:
        - async_loop_jobs is success
        - async_loop_jobs is changed
        - async_loop_jobs.results[0].duration > 0
        - async_loop_jobs.results[0].status_before == "not_created"
        - async_loop_jobs.results[0].status_after == "running"
        - async_loop_jobs.results[1].duration > 0
        - async_loop_jobs.results[1].status_before == "not_created"
        - async_loop_jobs.results[1].status_after == "running"
        - '"==> srv001: Booting VM..." in async_loop_jobs.results[0].stdout_lines'
        - '"==> srv002: Booting VM..." in async_loop_jobs.results[1].stdout_lines'
