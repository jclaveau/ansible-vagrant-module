---
# - name: Find out playbook's path
#   shell: pwd
#   register: playbook_path_output
# - debug: var=playbook_path_output.stdout

- name: Start with no Vagrantfile / vagrant-hosts.yml
  ansible.builtin.file:
    path: ./vagrant-hosts.yml
    state: absent

- name: Create synced folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  loop:
    - /tmp/srv001
    - /tmp/srv002
    - /tmp/var/www/html

- name: Add two vms to the Vagrantfile
  jclaveau.vagrant.config:
  args:
    state: "present"
    name: "{{ item }}"
    config:
      box: debian/buster64
      memory: 2048
      cpus: 2
      ip: "172.20.0.{{ i }}"
      netmask: 255.255.0.0
      mac: '13:37:de:ad:be:ef'
      # playbook: "{ item }.yml"
      forwarded_ports:
        - host: "808{{ i }}"
          guest: 80
        - host: "8{{ i }}43"
          guest: 443
      synced_folders:
        - src: "/tmp"
          dest: "/tmp/{{ item }}"
        - src: /var/www
          dest: /tmp/{{ item }}/www/html
          options:
            :create: true
            :owner: root
            :group: root
            :mount_options: ['dmode=0755', 'fmode=0644']
  register: vagrant_config_add_results
  loop:
    - "srv001"
    - "srv002"
  loop_control:
    index_var: "i"

- name: dbg up results
  ansible.builtin.debug:
    msg: "{{ vagrant_config_add_results }}"
  tags:
   - never
   - debug

- name: Vagrant config should succeed
  assert:
    that:
      - vagrant_config_add_results is success
      - vagrant_config_add_results is changed
      - vagrant_config_add_results.results | count == 2
      - vagrant_config_add_results.results[0].vms.needs == ['up']
      - vagrant_config_add_results.results[1].vms.needs == ['up']

- name: Register expected vagrant-hosts.yml content
  no_log: true
  ansible.builtin.set_fact:
    expected_vagrant_hosts_content:
      - box: debian/buster64
        cpus: 2
        forwarded_ports:
        - guest: 80
          host: '8080'
        - guest: 443
          host: '8043'
        ip: 172.20.0.0
        mac: 13:37:de:ad:be:ef
        memory: 2048
        name: srv001
        netmask: 255.255.0.0
        synced_folders:
        - dest: /tmp/srv001
          src: /tmp
        - dest: /tmp/srv001/www/html
          options:
            :create: true
            :group: root
            :mount_options:
            - dmode=0755
            - fmode=0644
            :owner: root
          src: /var/www
      - box: debian/buster64
        cpus: 2
        forwarded_ports:
        - guest: 80
          host: '8081'
        - guest: 443
          host: '8143'
        ip: 172.20.0.1
        mac: 13:37:de:ad:be:ef
        memory: 2048
        name: srv002
        netmask: 255.255.0.0
        synced_folders:
        - dest: /tmp/srv002
          src: /tmp
        - dest: /tmp/srv002/www/html
          options:
            :create: true
            :group: root
            :mount_options:
            - dmode=0755
            - fmode=0644
            :owner: root
          src: /var/www

- name: vagrant-hosts.yml should contain
  assert:
    that:
      - "{{ item |from_yaml }} ==  {{ expected_vagrant_hosts_content }} "
  with_file:
    - ./vagrant-hosts.yml

# - name: dbg host file
#   ansible.builtin.debug:
#     msg: "{{ item }}"
#   with_file:
#     - ./vagrant-hosts.yml
  # tags:
  #  - never
  #  - debug

# add new on an already existing config file
- name: Add new vm on an already existing  Vagrantfile
  jclaveau.vagrant.config:
  args:
    state: "present"
    name: "srv003"
    config:
      box: debian/buster64
  register: vagrant_config_add_results

- name: dbg results
  ansible.builtin.debug:
    msg: "{{ vagrant_config_add_results }}"
  # tags:
  #  - never
  #  - debug

# - name: dbg host file
#   ansible.builtin.debug:
#     msg: "{{ item }}"
#   with_file:
#     - ./vagrant-hosts.yml
  # tags:
  #  - never
  #  - debug

- name: Vagrant config should succeed
  assert:
    that:
      - vagrant_config_add_results is success
      - vagrant_config_add_results is changed
      - vagrant_config_add_results.vms.needs == ['up']

- name: Register expected vagrant-hosts.yml content
  no_log: true
  ansible.builtin.set_fact:
    expected_vagrant_hosts_content:
      - box: debian/buster64
        cpus: 2
        forwarded_ports:
        - guest: 80
          host: '8080'
        - guest: 443
          host: '8043'
        ip: 172.20.0.0
        mac: 13:37:de:ad:be:ef
        memory: 2048
        name: srv001
        netmask: 255.255.0.0
        synced_folders:
        - dest: /tmp/srv001
          src: /tmp
        - dest: /tmp/srv001/www/html
          options:
            :create: true
            :group: root
            :mount_options:
            - dmode=0755
            - fmode=0644
            :owner: root
          src: /var/www
      - box: debian/buster64
        cpus: 2
        forwarded_ports:
        - guest: 80
          host: '8081'
        - guest: 443
          host: '8143'
        ip: 172.20.0.1
        mac: 13:37:de:ad:be:ef
        memory: 2048
        name: srv002
        netmask: 255.255.0.0
        synced_folders:
        - dest: /tmp/srv002
          src: /tmp
        - dest: /tmp/srv002/www/html
          options:
            :create: true
            :group: root
            :mount_options:
            - dmode=0755
            - fmode=0644
            :owner: root
          src: /var/www
      - box: debian/buster64
        name: srv003

- name: vagrant-hosts.yml should contain
  assert:
    that:
      - "{{ item |from_yaml }} ==  {{ expected_vagrant_hosts_content }} "
  with_file:
    - ./vagrant-hosts.yml

# remove one box => need_destroy
- name: Remove srv002
  jclaveau.vagrant.config:
  args:
    state: "absent"
    name: "{{ item }}"
    config:
      box: debian/buster64
  register: vagrant_config_absent_results
  tags:
   - destroy
  loop:
    - "srv002"
    - "srv004"

- name: dbg absent results
  ansible.builtin.debug:
    msg: "{{ vagrant_config_absent_results }}"
  tags:
   - never
   - debug
   - destroy

- name: Vagrant config should succeed
  assert:
    that:
      - vagrant_config_absent_results is success
      - vagrant_config_absent_results is changed
      - vagrant_config_absent_results.results[0].vms.needs == ['destroy']
      - vagrant_config_absent_results.results[1].vms.needs == []
  tags:
   - destroy

- name: Register expected vagrant-hosts.yml content
  no_log: true
  ansible.builtin.set_fact:
    expected_vagrant_hosts_content:
      - box: debian/buster64
        cpus: 2
        forwarded_ports:
        - guest: 80
          host: '8080'
        - guest: 443
          host: '8043'
        ip: 172.20.0.0
        mac: 13:37:de:ad:be:ef
        memory: 2048
        name: srv001
        netmask: 255.255.0.0
        synced_folders:
        - dest: /tmp/srv001
          src: /tmp
        - dest: /tmp/srv001/www/html
          options:
            :create: true
            :group: root
            :mount_options:
            - dmode=0755
            - fmode=0644
            :owner: root
          src: /var/www
      - box: debian/buster64
        name: srv003

- name: vagrant-hosts.yml should contain
  assert:
    that:
      - "{{ item |from_yaml }} ==  {{ expected_vagrant_hosts_content }} "
  with_file:
    - ./vagrant-hosts.yml

# Dump the config
- name: Dump srv003
  jclaveau.vagrant.config:
  args:
    name: "srv001"
    # config:
    #   box: debian/buster64
  register: vagrant_config_dump_results
  tags:
   - dump

- name: dbg dump results
  ansible.builtin.debug:
    msg: "{{ vagrant_config_dump_results }}"
  tags:
   - never
   - debug
   - dump

- name: Register expected dump content
  no_log: true
  ansible.builtin.set_fact:
    expected_dump_content:
      box: debian/buster64
      cpus: 2
      forwarded_ports:
      - guest: 80
        host: '8080'
      - guest: 443
        host: '8043'
      ip: 172.20.0.0
      mac: 13:37:de:ad:be:ef
      memory: 2048
      name: srv001
      netmask: 255.255.0.0
      synced_folders:
      - dest: /tmp/srv001
        src: /tmp
      - dest: /tmp/srv001/www/html
        options:
          :create: true
          :group: root
          :mount_options:
          - dmode=0755
          - fmode=0644
          :owner: root
        src: /var/www
  tags:
   - dump


- name: Vagrant config should succeed
  assert:
    that:
      - vagrant_config_dump_results is success
      - vagrant_config_dump_results is not changed
      - "{{ vagrant_config_dump_results.vms[0] }} ==  {{ expected_dump_content }} "
  tags:
   - dump
