---
# This section fires up a set of guests dynamically using vagrant,
# logs in and destroy them

- name: Fire up 2 vagrant instances to log into
  jclaveau.vagrant.vagrant:
  args:
    command: up
    box_name: "{{box_name}}"
    box_path: "{{box_path_virtualbox}}"
    vm_name: "frank"
    count: 2
    config_code: |
      config.vm.provider "virtualbox" do |vb|
      vb.memory = 256
      end
    log: true
  register: vagrant

# Simple SSH connection
- include_tasks: shell_ssh_connection_printing_hostname.yml

- name: SSH connection should succeed
  assert:
    that:
      - ssh_results is success
      - ssh_results is changed
      - ssh_results.results[0].stdout == ssh_results.results[0].item.hostname
      - ssh_results.results[1].stdout == ssh_results.results[1].item.hostname

# vagrant status
- name: Fire up a new VM called fred
  jclaveau.vagrant.vagrant:
  args:
    command: up
    box_name: "{{box_name}}"
    box_path: "{{box_path_virtualbox}}"
    vm_name: "fred"
    log: true
  register: vagrant

- include_tasks: vagrant_status_test.yml

# vagrant clear (destroy all vms and remove config files)
- name: Destroy vms and delete config files
  local_action:
    module: vagrant
    command: clear

- include_tasks: shell_ssh_connection_printing_hostname.yml

- name: SSH connection should fail
  assert:
    that:
      - ssh_results is failed
      - ssh_results is changed
      - "'Connection refused' in ssh_results.results[0].stderr"
      - "'Connection refused' in ssh_results.results[0].stderr"