# Equivalent of "vagrant halt" command
# Case 1
- name: Retrieve vagrant status of instances named "non_existing_vm"
  local_action:
    module: vagrant
    command: halt
    vm_name: non_existing_vm
    log: true
  register: vagrant_halt_result
  ignore_errors: true

- name: dbg vagrant_halt_result
  ansible.builtin.debug:
    msg: "{{ vagrant_halt_result }}"
  tags:
   - never
   - debug

- name: Vagrant halt should display an error
  assert:
    that:
      - vagrant_halt_result is failed
      - vagrant_halt_result is not changed
      - "vagrant_halt_result.msg == 'Vagrant::Errors::MachineNotFound: The machine with the name \\'non_existing_vm\\' was not found configured for this Vagrant environment.'"

# Case 2
- name: Call halt on instances named frank
  local_action:
    module: vagrant
    command: halt
    vm_name: frank
    log: true
  register: vagrant_halt_result

- name: dbg vagrant_halt_result
  ansible.builtin.debug:
    msg: "{{ vagrant_halt_result }}"
  tags:
   - never
   - debug

- name: Vagrant halt should succeed
  assert:
    that:
      - vagrant_halt_result is success
      - vagrant_halt_result is changed
      - vagrant_halt_result.status | count == 1
      - vagrant_halt_result.status.frank.name == "frank"
      - vagrant_halt_result.status.frank.state == "poweroff"
      - vagrant_halt_result.status.frank.provider == "virtualbox"

# Case 3
- name: Call halt on instances named frank
  local_action:
    module: vagrant
    command: halt
    vm_name:
     - frank
     - frank_inst2
    log: true
  register: vagrant_halt_result

- name: dbg vagrant_halt_result
  ansible.builtin.debug:
    msg: "{{ vagrant_halt_result }}"
  tags:
   - never
   - debug

- name: Vagrant halt should succeed
  assert:
    that:
      - vagrant_halt_result is success
      - vagrant_halt_result is changed
      - vagrant_halt_result.status | count == 2
      - vagrant_halt_result.status.frank.name == "frank"
      - vagrant_halt_result.status.frank.state == "poweroff"
      - vagrant_halt_result.status.frank.provider == "virtualbox"
      - vagrant_halt_result.status.frank_inst2.name == "frank_inst2"
      - vagrant_halt_result.status.frank_inst2.state == "poweroff"
      - vagrant_halt_result.status.frank_inst2.provider == "virtualbox"

# Case 4: without specified vm name
- name: Call halt without vm_name
  local_action:
    module: vagrant
    command: halt
    log: true
  register: vagrant_halt_result

- name: dbg vagrant_halt_result
  ansible.builtin.debug:
    msg: "{{ vagrant_halt_result }}"
  tags:
   - never
   - debug

- name: Vagrant halt should succeed
  assert:
    that:
      - vagrant_halt_result is success
      - vagrant_halt_result is changed
      - vagrant_halt_result.status | count == 3
      - vagrant_halt_result.status.frank.name == "frank"
      - vagrant_halt_result.status.frank.state == "poweroff"
      - vagrant_halt_result.status.frank.provider == "virtualbox"
      - vagrant_halt_result.status.frank_inst2.name == "frank_inst2"
      - vagrant_halt_result.status.frank_inst2.state == "poweroff"
      - vagrant_halt_result.status.frank_inst2.provider == "virtualbox"
      - vagrant_halt_result.status.fred.name == "fred"
      - vagrant_halt_result.status.fred.state == "poweroff"
      - vagrant_halt_result.status.fred.provider == "virtualbox"
